name: Auto Generate Algorithm Analysis

on:
  push:
    paths:
      - '**/*.cc'
      - '**/*.cpp'

  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: false
        default: 'latest'
        type: choice
        options:
          - latest
          - diff

permissions:
  contents: write

jobs:
  analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure git to keep UTF-8 paths
        run: |
          git config --global core.quotepath false

      - name: Resolve target C++ files
        id: resolve
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.mode }}" == "latest" ]]; then
            echo "Manual mode: latest file"

            FILE=$(git log -1 --name-only --pretty=format: -- '*.cc' '*.cpp' | head -1)

            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

          else
            echo "Auto mode: diff files"

            echo "files<<EOF" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -E '\.(cc|cpp)$' || true
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate analysis with Gemini
        if: steps.resolve.outputs.files != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node .github/scripts/analyze.mjs ${{ steps.resolve.outputs.files }}

      - name: Commit analysis files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "docs: ${{ steps.resolve.outputs.files }} analysis" || echo "No changes"
          git push
